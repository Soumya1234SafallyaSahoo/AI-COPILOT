<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Day 12 — Conversational Agent UI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg:#0b1020;
      --card:#121831;
      --muted:#a7b0d0;
      --text:#e8ecf8;
      --accent:#ff3b6a;
      --accent-2:#ff8ab4;
      --ok:#2ecc71;
      --warn:#f1c40f;
      --err:#ff5a5a;
      --ring: rgba(255,59,106,0.35);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body {
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      color:var(--text);
      background:
        radial-gradient(60vw 60vw at 10% 0%, #1b1f3a 0%, transparent 60%),
        radial-gradient(50vw 50vw at 90% 10%, #1b1438 0%, transparent 60%),
        var(--bg);
      display:grid;
      place-items:center;
      padding:24px;
    }
    .card {
      width:min(680px, 95vw);
      background:linear-gradient(180deg, rgba(255,255,255,0.04), transparent), var(--card);
      border:1px solid rgba(255,255,255,0.08);
      border-radius:20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.35);
      padding:28px;
    }
    .row{display:flex; align-items:center; gap:18px; flex-wrap:wrap}
    .title{font-size:22px; font-weight:700; letter-spacing:.2px}
    .muted{color:var(--muted); font-size:14px}
    .spacer{height:10px}
    .divider{height:1px; background:rgba(255,255,255,0.08); margin:16px 0}
    .pill{
      padding:6px 10px; border-radius:999px; font-size:12px; font-weight:600;
      background:rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.08)
    }
    .mic-wrap{display:flex; align-items:center; gap:18px; flex-wrap:wrap}
    .mic{
      position:relative;
      width:96px; height:96px; border-radius:999px; border:none; cursor:pointer;
      color:white; font-size:14px; font-weight:700; letter-spacing:.3px;
      background: radial-gradient(60% 60% at 35% 30%, var(--accent-2), var(--accent));
      box-shadow: 0 8px 30px rgba(255,59,106,0.35), inset 0 1px 10px rgba(255,255,255,0.25);
      transition: transform .15s ease, filter .2s ease, box-shadow .2s ease;
      outline: none;
    }
    .mic:active{ transform: scale(.98) }
    .mic[disabled]{ filter: grayscale(.2) brightness(.8); cursor:not-allowed }
    .mic.recording::before,
    .mic.recording::after{
      content:"";
      position:absolute; inset:-10px;
      border-radius:inherit;
      border:2px solid var(--ring);
      animation: pulse 1.6s ease-out infinite;
    }
    .mic.recording::after{ inset:-20px; animation-delay:.8s; }
    @keyframes pulse{
      0%{ opacity:.8; transform: scale(.85) }
      100%{ opacity:0; transform: scale(1.25) }
    }
    .light{ width:10px; height:10px; border-radius:999px; }
    .light.idle{ background:#7f8ea3 }
    .light.rec{ background:var(--warn); box-shadow:0 0 8px var(--warn) }
    .light.proc{ background:#6fa7ff; box-shadow:0 0 8px #6fa7ff }
    .light.play{ background:var(--ok); box-shadow:0 0 8px var(--ok) }
    .light.err{ background:var(--err); box-shadow:0 0 8px var(--err) }
    .status{ font-weight:600; letter-spacing:.2px; }
    .big{
      font-size:15px;
      padding:8px 12px; border-radius:12px;
      background:rgba(255,255,255,0.04); border:1px solid rgba(255,255,255,0.08)
    }
    .log{
      background:rgba(255,255,255,0.03);
      border:1px solid rgba(255,255,255,0.08);
      border-radius:14px;
      padding:14px;
      max-height:160px; overflow:auto;
      font-size:13px; line-height:1.55;
    }
    .log b{ color:#d9e2ff }
    .right{ margin-left:auto; display:flex; align-items:center; gap:10px }
    .ghost{
      background:transparent; color:var(--muted);
      border:1px dashed rgba(255,255,255,0.18);
      padding:6px 10px; border-radius:10px; cursor:pointer; font-weight:600
    }
    .hidden{ display:none !important }
  </style>
</head>
<body>
  <main class="card">
    <div class="row">
      <div class="title">Conversational Agent</div>
      <span class="pill">Day 12 Revamped UI</span>
      <div class="right">
        <button id="togglePlayer" class="ghost">Show Player</button>
      </div>
    </div>
    <div class="spacer"></div>
    <div class="divider"></div>
    <div class="row mic-wrap">
      <button id="recordBtn" class="mic"><span id="btnLabel">Start</span></button>
      <div class="big row">
        <div id="stateDot" class="light idle"></div>
        <div class="status" id="status">Idle — click to start</div>
        <div class="pill" id="timer">00:00</div>
      </div>
    </div>
    <div class="spacer"></div>
    <div class="row"><div class="muted">Session log</div></div>
    <div id="log" class="log"></div>
    <audio id="player" class="hidden" controls preload="auto"></audio>
  </main>

  <script>
    const ENDPOINT = "http://localhost:8000/respond"; // backend route
    const recordBtn = document.getElementById("recordBtn");
    const btnLabel = document.getElementById("btnLabel");
    const statusEl = document.getElementById("status");
    const dot = document.getElementById("stateDot");
    const timerEl = document.getElementById("timer");
    const logEl = document.getElementById("log");
    const player = document.getElementById("player");
    const togglePlayerBtn = document.getElementById("togglePlayer");

    let mediaStream = null, mediaRecorder = null, chunks = [], state = "idle", startedAt = null, timerHandle = null;

    function setState(next){
      state = next;
      recordBtn.classList.toggle("recording", state === "recording");
      if(state === "idle"){ btnLabel.textContent = "Start"; dot.className = "light idle"; setStatus("Idle — click to start"); stopTimer(true); }
      if(state === "recording"){ btnLabel.textContent = "Stop"; dot.className = "light rec"; setStatus("Recording… click to stop"); startTimer(); }
      if(state === "processing"){ btnLabel.textContent = "Processing"; dot.className = "light proc"; setStatus("Processing…"); stopTimer(false); }
      if(state === "playing"){ btnLabel.textContent = "Stop"; dot.className = "light play"; setStatus("Playing reply…"); stopTimer(false); }
      if(state === "error"){ btnLabel.textContent = "Start"; dot.className = "light err"; }
    }
    function setStatus(t){ statusEl.textContent = t; }
    function log(msg){ const p = document.createElement("div"); p.innerHTML = msg; logEl.prepend(p); }
    function startTimer(){
      startedAt = Date.now();
      if(timerHandle) clearInterval(timerHandle);
      timerHandle = setInterval(()=>{
        const s = Math.floor((Date.now() - startedAt)/1000);
        const m = String(Math.floor(s/60)).padStart(2,"0");
        const r = String(s%60).padStart(2,"0");
        timerEl.textContent = `${m}:${r}`;
      }, 250);
    }
    function stopTimer(reset){
      if(timerHandle) clearInterval(timerHandle);
      if(reset) timerEl.textContent = "00:00";
    }
    async function ensureMic(){
      if(mediaStream) return mediaStream;
      mediaStream = await navigator.mediaDevices.getUserMedia({ audio:true });
      return mediaStream;
    }
    async function startRecording(){
      await ensureMic();
      chunks = [];
      mediaRecorder = new MediaRecorder(mediaStream);
      mediaRecorder.ondataavailable = e => { if(e.data.size) chunks.push(e.data); };
      mediaRecorder.onstop = onRecordingStop;
      mediaRecorder.start();
      setState("recording");
      log(`<b>Recording:</b> started`);
    }
    async function stopRecording(){
      if(mediaRecorder && mediaRecorder.state !== "inactive"){ mediaRecorder.stop(); }
    }
    async function onRecordingStop(){
      try{
        setState("processing");
        const blob = new Blob(chunks, { type: mediaRecorder.mimeType });
        const fd = new FormData();
        fd.append("audio", blob, "input.webm");
        const resp = await fetch(ENDPOINT, { method:"POST", body: fd });
        if(!resp.ok) throw new Error(`Server ${resp.status}`);
        const audioBlob = await resp.blob();
        const audioSrc = URL.createObjectURL(audioBlob);
        await playAudio(audioSrc);
      }catch(err){
        setState("error");
        log(`<b>Error:</b> ${err.message}`);
      }
    }
    async function playAudio(src){
      player.src = src;
      setState("playing");
      try{ await player.play(); }
      catch{ player.classList.remove("hidden"); }
      player.onended = ()=> setState("idle");
    }
    recordBtn.addEventListener("click", ()=>{
      if(state === "idle"){ startRecording(); }
      else if(state === "recording"){ stopRecording(); }
      else if(state === "playing"){ player.pause(); setState("idle"); }
    });
    togglePlayerBtn.addEventListener("click", ()=>{
      player.classList.toggle("hidden");
      togglePlayerBtn.textContent = player.classList.contains("hidden") ? "Show Player" : "Hide Player";
    });
  </script>
</body>
</html>

